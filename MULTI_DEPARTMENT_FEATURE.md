# ویژگی سیستم تیکت چند بخشی

این سند راهنمای پیاده‌سازی ویژگی جدید سیستم تیکت برای پشتیبانی از چند بخش است.

## خلاصه تغییرات

### 1. مدل Branch (شعبه)
- مدل جدید `Branch` برای مدیریت شعبه‌ها (موقعیت/مکان)
- هر شعبه دارای کد یکتا در هر بخش است
- عملیات CRUD کامل برای مدیریت شعبه‌ها

### 2. به‌روزرسانی مدل Department
- فیلد `can_receive_tickets`: امکان دریافت تیکت برای هر بخش (پیش‌فرض: غیرفعال)
- فیلد `branch`: اتصال اجباری به شعبه

### 3. به‌روزرسانی مدل Ticket
- فیلد `branch`: شعبه انتخاب شده توسط کاربر
- فیلد `target_department`: بخش هدف که تیکت برای آن ارسال شده است

### 4. فرم‌ها
- `BranchForm`: فرم مدیریت شعبه‌ها
- به‌روزرسانی `DepartmentForm`: شامل چک‌باکس `can_receive_tickets` و انتخاب شعبه
- به‌روزرسانی `TicketForm`: انتخاب اول شعبه، سپس بخش

### 5. ویوها
- مدیریت شعبه‌ها: `branch_management`, `branch_create`, `branch_edit`, `branch_delete`
- تیکت‌های دریافتی: `received_tickets` (برای سرپرست‌های بخش)
- API endpoint: `get_departments_for_branch` (برای بارگذاری داینامیک بخش‌ها)

### 6. قالب‌ها
- `branch_management.html`: لیست شعبه‌ها
- `branch_form.html`: فرم ایجاد/ویرایش شعبه
- `branch_confirm_delete.html`: تأیید حذف شعبه
- `received_tickets.html`: نمایش تیکت‌های دریافتی برای سرپرست‌ها
- به‌روزرسانی `ticket_form.html`: انتخاب شعبه و بخش با JavaScript

## دستورات Docker برای اجرای Migration

### 1. ساخت Migration
```bash
docker-compose exec web python manage.py makemigrations
```

### 2. اعمال Migration
```bash
docker-compose exec web python manage.py migrate
```

### 3. در صورت نیاز به بازنشانی دیتابیس (اختیاری)
```bash
# توجه: این دستور تمام داده‌ها را پاک می‌کند
docker-compose exec web python manage.py flush --no-input
docker-compose exec web python manage.py migrate
```

### 4. راه‌اندازی مجدد سرویس (در صورت نیاز)
```bash
docker-compose restart web
```

## مراحل راه‌اندازی

1. **ایجاد شعبه‌ها**: 
   - مدیر IT باید ابتدا شعبه‌ها را ایجاد کند
   - هر شعبه باید دارای کد یکتا در هر بخش باشد

2. **تنظیم بخش‌ها**:
   - برای هر بخش، یک شعبه انتخاب کنید (الزامی)
   - در صورت نیاز، چک‌باکس "می‌تواند تیکت دریافت کند" را فعال کنید

3. **ایجاد تیکت**:
   - کاربر ابتدا شعبه را انتخاب می‌کند
   - سپس بخش‌های فعال (که می‌توانند تیکت دریافت کنند) نمایش داده می‌شوند
   - کاربر بخش مورد نظر را انتخاب می‌کند

4. **مشاهده تیکت‌های دریافتی**:
   - سرپرست‌های بخش می‌توانند از منوی "تیکت‌های دریافتی" تیکت‌های ارسال شده به بخش خود را مشاهده کنند

## نکات مهم

- تمام متن‌ها به فارسی هستند
- طراحی با زبان طراحی موجود سایت هماهنگ است
- شعبه برای تمام بخش‌ها (چه فعال و چه غیرفعال برای دریافت تیکت) الزامی است
- فقط بخش‌هایی که `can_receive_tickets=True` دارند در فرم ایجاد تیکت نمایش داده می‌شوند
- هر شعبه دارای کد یکتا در هر بخش است (unique constraint)

## تست

پس از اعمال migration، موارد زیر را تست کنید:

1. ایجاد شعبه جدید
2. ایجاد بخش جدید با انتخاب شعبه
3. فعال کردن `can_receive_tickets` برای یک بخش
4. ایجاد تیکت جدید (انتخاب شعبه و بخش)
5. مشاهده تیکت‌های دریافتی توسط سرپرست بخش


